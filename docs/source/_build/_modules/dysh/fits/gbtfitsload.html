<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dysh.fits.gbtfitsload &mdash; dysh 0.2.0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=938c9ccc"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true, useMaxWidth:false});</script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../background/index.html">Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design/index.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Modules and APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples for GBT Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../performance_testing/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../for_beta_testers/index.html">For Beta Testers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../for_developers/index.html">For Developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">dysh</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dysh.fits.gbtfitsload</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dysh.fits.gbtfitsload</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Load SDFITS files produced by the Green Bank Telescope&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.units</span> <span class="kn">import</span> <span class="n">cds</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">..spectra.core</span> <span class="kn">import</span> <span class="n">tsys_weight</span>
<span class="kn">from</span> <span class="nn">..spectra.spectrum</span> <span class="kn">import</span> <span class="n">Spectrum</span>
<span class="kn">from</span> <span class="nn">..spectra.scan</span> <span class="kn">import</span> <span class="n">GBTPSScan</span><span class="p">,</span><span class="n">GBTTPScan</span>
<span class="kn">from</span> <span class="nn">..spectra.obsblock</span> <span class="kn">import</span> <span class="n">Obsblock</span>
<span class="kn">from</span> <span class="nn">.sdfitsload</span> <span class="kn">import</span> <span class="n">SDFITSLoad</span>
<span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">uniq</span><span class="p">,</span> <span class="n">consecutive</span>

<span class="c1"># from GBT IDL users guide Table 6.7</span>
<span class="n">_PROCEDURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Track&quot;</span><span class="p">,</span> <span class="s2">&quot;OnOff&quot;</span><span class="p">,</span> <span class="s2">&quot;OffOn&quot;</span><span class="p">,</span> <span class="s2">&quot;OffOnSameHA&quot;</span><span class="p">,</span> <span class="s2">&quot;Nod&quot;</span><span class="p">,</span> <span class="s2">&quot;SubBeamNod&quot;</span><span class="p">]</span> 

<div class="viewcode-block" id="GBTFITSLoad">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad">[docs]</a>
<span class="k">class</span> <span class="nc">GBTFITSLoad</span><span class="p">(</span><span class="n">SDFITSLoad</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;GBT-specific container for bintables from selected HDU(s)&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">hdu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">SDFITSLoad</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">hdu</span><span class="p">)</span><span class="c1">#,fix=False)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_proc</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==GBTLoad </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;SCAN&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;SAMPLER&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="s1">&#39;PLNUM&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="s1">&#39;IFNUM&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;SIG&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;CAL&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;PROCSEQN&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;PROCSIZE&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;OBSMODE&#39;</span><span class="p">)</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">ushow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;SIDEBAND&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_compute_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the procedure string from obsmode and add to index&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">)):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;OBSMODE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;PROC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Assign these to something that might be usefule later, since we have them</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;_OBSTYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;_SUBOBSMODE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="GBTFITSLoad.summary">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.summary">[docs]</a>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bintable</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="c1"># From GBTIDL:</span>
<span class="c1"># Intended to work with un-calibrated GBT data and is</span>
<span class="c1"># likely to give confusing results for other data.  For other data,</span>
<span class="c1"># list is usually more useful.</span>
<span class="c1">#</span>
<span class="c1"># @TODO perhaps return as a astropy.Table then we can have units</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a summary list of the input dataset.   </span>
<span class="sd">            If `verbose=False` (default), some numeric data </span>
<span class="sd">            (e.g., RESTFREQ, AZIMUTH, ELEVATIO) are </span>
<span class="sd">            averaged over the records with the same scan number.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scans : int or 2-tuple</span>
<span class="sd">                The scan(s) to use. A 2-tuple represents (beginning, ending) scans. Default: show all scans</span>

<span class="sd">            verbose: bool</span>
<span class="sd">                If True, list every record, otherwise return a compact summary</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            summary - `~pandas.DataFrame`</span>
<span class="sd">                Summary of the data as a DataFrame.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#@todo allow user to change show list</span>
        <span class="c1">#@todo set individual format options on output by</span>
        <span class="c1"># changing these to dicts(?)</span>
        <span class="c1">#</span>
        <span class="c1"># &#39;show&#39; is fragile because anything we might need to query in &#39;uf&#39; below in </span>
        <span class="c1"># order to do a calculation,  whether we want to show it, or not must be in &#39;show.&#39;  </span>
        <span class="c1"># (e.g. PROCSIZE is needed to calculate n_integrations).</span>
        <span class="n">show</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;OBJECT&quot;</span><span class="p">,</span> <span class="s2">&quot;VELOCITY&quot;</span><span class="p">,</span> <span class="s2">&quot;PROC&quot;</span><span class="p">,</span> <span class="s2">&quot;PROCSEQN&quot;</span><span class="p">,</span> <span class="s2">&quot;PROCSIZE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;RESTFREQ&quot;</span><span class="p">,</span> <span class="s2">&quot;DOPFREQ&quot;</span><span class="p">,</span> <span class="s2">&quot;IFNUM&quot;</span><span class="p">,</span><span class="s2">&quot;FEED&quot;</span><span class="p">,</span> <span class="s2">&quot;AZIMUTH&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEVATIO&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;FDNUM&quot;</span><span class="p">,</span> <span class="s2">&quot;PLNUM&quot;</span><span class="p">,</span> <span class="s2">&quot;SIG&quot;</span><span class="p">,</span> <span class="s2">&quot;CAL&quot;</span><span class="p">,</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span> 
        <span class="n">comp_colnames</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;OBJECT&quot;</span><span class="p">,</span> <span class="s2">&quot;VELOCITY&quot;</span><span class="p">,</span> <span class="s2">&quot;PROC&quot;</span><span class="p">,</span> <span class="s2">&quot;PROCSEQN&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;RESTFREQ&quot;</span><span class="p">,</span> <span class="s2">&quot;DOPFREQ&quot;</span><span class="p">,</span> <span class="s2">&quot;# IF&quot;</span><span class="p">,</span><span class="s2">&quot;# POL&quot;</span><span class="p">,</span> <span class="s2">&quot;# INT&quot;</span><span class="p">,</span> <span class="s2">&quot;# FEED&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;AZIMUTH&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEVATIO&quot;</span><span class="p">]</span>
        <span class="c1"># In the process, some columns get cast to floats or others. Make sure we cast them</span>
        <span class="c1"># back to an appropriate data type before return.</span>
        <span class="n">col_dtypes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SCAN&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;PROCSEQN&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">}</span>
        <span class="n">uncompressed_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_index</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">:</span>
            <span class="c1"># make a copy here because we can&#39;t guarantee if this is a </span>
            <span class="c1"># view or a copy without it. See https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy</span>
            <span class="n">_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">show</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;VELOCITY&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="mf">1E3</span>   <span class="c1"># convert to km/s</span>
            <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;RESTFREQ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;RESTFREQ&quot;</span><span class="p">]</span><span class="o">/</span><span class="mf">1.0E9</span> <span class="c1"># convert to GHz</span>
            <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;DOPFREQ&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_df</span><span class="p">[</span><span class="s2">&quot;DOPFREQ&quot;</span><span class="p">]</span><span class="o">/</span><span class="mf">1.0E9</span> <span class="c1"># convert to GHz</span>
            <span class="k">if</span> <span class="n">scans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scans</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">scans</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="c1"># or should this be [scans[0],lastscan]?</span>
                <span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_scans</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span><span class="n">_df</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">show</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uncompressed_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">uncompressed_df</span> <span class="o">=</span> <span class="n">_df</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uncompressed_df</span> <span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">uncompressed_df</span><span class="p">,</span><span class="n">_df</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">uncompressed_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">uncompressed_df</span> <span class="o">=</span> <span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">show</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">uncompressed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">uncompressed_df</span><span class="p">,</span><span class="n">_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">show</span><span class="p">)])</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">uncompressed_df</span> <span class="o">=</span> <span class="n">uncompressed_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">col_dtypes</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">uncompressed_df</span>

        <span class="c1"># do the work to compress the info </span>
        <span class="c1"># in the dataframe on a scan basis</span>
        <span class="n">compressed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">comp_colnames</span><span class="p">)</span>
        <span class="n">scanset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">uncompressed_df</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">])</span>
        <span class="n">avg_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">,</span> <span class="s2">&quot;VELOCITY&quot;</span><span class="p">,</span> <span class="s2">&quot;PROCSEQN&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;RESTFREQ&quot;</span><span class="p">,</span> <span class="s2">&quot;DOPFREQ&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;AZIMUTH&quot;</span><span class="p">,</span> <span class="s2">&quot;ELEVATIO&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scanset</span><span class="p">:</span>
            <span class="n">uf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;SCAN&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">uncompressed_df</span><span class="p">)</span>
            <span class="c1"># for some columns we will display </span>
            <span class="c1"># the mean value</span>
            <span class="n">ser</span> <span class="o">=</span> <span class="n">uf</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">avg_cols</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ser</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;filtered ser&quot;</span><span class="p">)</span>
            <span class="c1"># for others we will count how many there are</span>
            <span class="n">nIF</span> <span class="o">=</span> <span class="n">uf</span><span class="p">[</span><span class="s2">&quot;IFNUM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="n">nPol</span> <span class="o">=</span> <span class="n">uf</span><span class="p">[</span><span class="s2">&quot;PLNUM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="n">nfeed</span> <span class="o">=</span> <span class="n">uf</span><span class="p">[</span><span class="s2">&quot;FEED&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="n">nint</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">uf</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]))</span> <span class="c1"># see gbtidl io/line_index__define.pro</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">uf</span><span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># We assume they are all the same!</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">uf</span><span class="p">[</span><span class="s2">&quot;PROC&quot;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># We assume they are all the same!</span>
            <span class="c1">#print(f&quot;Uniq data for scan {s}: {nint} {nIF} {nPol} {nfeed} {obj} {proc}&quot;)</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">obj</span><span class="p">,</span><span class="n">proc</span><span class="p">,</span><span class="n">nIF</span><span class="p">,</span><span class="n">nPol</span><span class="p">,</span><span class="n">nint</span><span class="p">,</span><span class="n">nfeed</span><span class="p">],</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;uniqued data&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;OBJECT&quot;</span><span class="p">,</span><span class="s2">&quot;PROC&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;# IF&quot;</span><span class="p">,</span><span class="s2">&quot;# POL&quot;</span><span class="p">,</span> <span class="s2">&quot;# INT&quot;</span><span class="p">,</span><span class="s2">&quot;# FEED&quot;</span><span class="p">])</span>
            <span class="n">ser</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ser</span><span class="p">,</span><span class="n">s2</span><span class="p">])</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">comp_colnames</span><span class="p">)</span>
            <span class="n">ser</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;appended ser&quot;</span><span class="p">)</span>
            <span class="c1">#print(&quot;append series data&quot;,ser)</span>
            <span class="c1">#print(&quot;append series index &quot;,ser.index)</span>
            <span class="c1">#print(&quot;df cols&quot;,compressed_df.columns)</span>
            <span class="c1">#print(&quot;SAME? &quot;,all(ser.index == compressed_df.columns))</span>
            <span class="n">compressed_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">compressed_df</span><span class="p">,</span><span class="n">ser</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">],</span>
                    <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compressed_df</span> <span class="o">=</span> <span class="n">compressed_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">col_dtypes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compressed_df</span></div>


<div class="viewcode-block" id="GBTFITSLoad.velocity_convention">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.velocity_convention">[docs]</a>
    <span class="k">def</span> <span class="nf">velocity_convention</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">veldef</span><span class="p">,</span><span class="n">velframe</span><span class="p">):</span>
        <span class="c1"># GBT uses VELDEF and VELFRAME incorrectly. </span>
        <span class="k">return</span> <span class="s2">&quot;doppler_radio&quot;</span></div>


<div class="viewcode-block" id="GBTFITSLoad.select_scans">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.select_scans">[docs]</a>
    <span class="k">def</span> <span class="nf">select_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scans</span><span class="p">,</span><span class="n">df</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">scans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">scans</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span></div>


<div class="viewcode-block" id="GBTFITSLoad.select_onoff">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.select_onoff">[docs]</a>
    <span class="k">def</span> <span class="nf">select_onoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PROC&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;OnOff&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;PROC&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OffOn&quot;</span><span class="p">)]</span></div>


<div class="viewcode-block" id="GBTFITSLoad.select">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.select">[docs]</a>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select data where key=value</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">            key : str</span>
<span class="sd">                The key value (SDFITS column name)</span>
<span class="sd">            value : any</span>
<span class="sd">                The value to match</span>
<span class="sd">            df : `~pandas.DataFrame`</span>
<span class="sd">                The DataFrame to search</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            df : `~pandas.DataFrame`</span>
<span class="sd">                The subselected DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">==</span><span class="n">value</span><span class="p">)]</span></div>


    <span class="k">def</span> <span class="nf">_create_index_if_needed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_index</span><span class="p">()</span>

<span class="c1">#        TODO: figure how to allow [startscan, endscan]</span>
<span class="c1">#            [sampler], ap_eff [if requested units are Jy]</span>
<div class="viewcode-block" id="GBTFITSLoad.getps">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.getps">[docs]</a>
    <span class="k">def</span> <span class="nf">getps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Get the rows that contain position-switched data.  These include ONs and OFFs.</span>

<span class="sd">           kwargs: plnum, feed, ifnum, integration, calibrate=T/F, average=T/F, tsys, weights</span>
<span class="sd">            </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scans : int or 2-tuple</span>
<span class="sd">                Single scan number or list of scan numbers to use. Default: all scans.</span>
<span class="sd">                Scan numbers can be Ons or Offs</span>
<span class="sd">            weights: str</span>
<span class="sd">                &#39;equal&#39; or &#39;tsys&#39; to indicate equal weighting or tsys weighting to use in time averaging. Default: &#39;tsys&#39;</span>

<span class="sd">        Returns </span>
<span class="sd">        -------</span>
<span class="sd">            psscan : `~spectra.scan.GBTPSScan`</span>
<span class="sd">                A `GBTPScan` object containing the data which can be calibrated.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># all ON/OFF scans</span>
        <span class="n">kwargs_opts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ifnum&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;plnum&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># I prefer &quot;pol&quot;</span>
            <span class="s1">&#39;fdnum&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;calibrate&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;timeaverage&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;polaverage&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;tsys&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;weights&#39;</span><span class="p">:</span> <span class="s1">&#39;tsys&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">kwargs_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ifnum</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;ifnum&#39;</span><span class="p">]</span>
        <span class="n">plnum</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;plnum&#39;</span><span class="p">]</span>
        <span class="n">scanlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onoff_scan_list</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span><span class="n">ifnum</span><span class="o">=</span><span class="n">ifnum</span><span class="p">,</span><span class="n">plnum</span><span class="o">=</span><span class="n">plnum</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="n">bintable</span><span class="p">)</span>
        <span class="c1"># add ifnum,plnum</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onoff_rows</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span><span class="n">ifnum</span><span class="o">=</span><span class="n">ifnum</span><span class="p">,</span><span class="n">plnum</span><span class="o">=</span><span class="n">plnum</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="n">bintable</span><span class="p">)</span>
        <span class="c1"># do not pass scan list here. We need all the cal rows. They will </span>
        <span class="c1"># be intersected with scan rows in GBTPSScan</span>
        <span class="c1"># add ifnum,plnum</span>
        <span class="n">calrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calonoff_rows</span><span class="p">(</span><span class="n">scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="n">bintable</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">GBTPSScan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scanlist</span><span class="p">,</span><span class="n">rows</span><span class="p">,</span><span class="n">calrows</span><span class="p">,</span><span class="n">bintable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span></div>


<div class="viewcode-block" id="GBTFITSLoad.gettp">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.gettp">[docs]</a>
    <span class="k">def</span> <span class="nf">gettp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scan</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a total power scan, optionally calibrating it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scan: int</span>
<span class="sd">                scan number</span>
<span class="sd">            sig : bool or None</span>
<span class="sd">                True to use only integrations where signal state is True, False to use reference state (signal state is False). None to use all integrations.</span>
<span class="sd">            cal: bool or None</span>
<span class="sd">                True to use only integrations where calibration (diode) is on, False if off. None to use all integrations regardless calibration state. The system temperature will be calculated from both states regardless of the value of this variable.</span>
<span class="sd">            bintable : int</span>
<span class="sd">                the index for BINTABLE in `sdfits` containing the scans</span>
<span class="sd">            calibrate: bool</span>
<span class="sd">                whether or not to calibrate the data.  If `True`, the data will be (calon - caloff)*0.5, otherwise it will be SDFITS row data. Default:True</span>
<span class="sd">            weights: str</span>
<span class="sd">                &#39;equal&#39; or &#39;tsys&#39; to indicate equal weighting or tsys weighting to use in time averaging. Default: &#39;tsys&#39;</span>

<span class="sd">            scan args - ifnum, plnum, fdnum, subref</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            data : `~spectra.scan.GBTTPScan`</span>
<span class="sd">                A Spectrum object containing the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs_opts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ifnum&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;plnum&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                <span class="s1">&#39;fdnum&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;subref&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># subreflector position</span>
                <span class="s1">&#39;timeaverage&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;polaverage&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;weights&#39;</span> <span class="p">:</span> <span class="s1">&#39;tsys&#39;</span><span class="p">,</span> <span class="c1"># or &#39;tsys&#39; or ndarray</span>
                <span class="s1">&#39;calibrate&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>   
        <span class="n">kwargs_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">TF</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span><span class="s1">&#39;F&#39;</span><span class="p">}</span>
        <span class="n">sigstate</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;SIG&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span><span class="s1">&#39;REF&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span><span class="s1">&#39;BOTH&#39;</span><span class="p">}</span>
        <span class="n">calstate</span> <span class="o">=</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;ON&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span><span class="s1">&#39;OFF&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span><span class="s1">&#39;BOTH&#39;</span><span class="p">}</span>

        <span class="n">ifnum</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;ifnum&#39;</span><span class="p">]</span>
        <span class="n">plnum</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;plnum&#39;</span><span class="p">]</span>
        <span class="n">fdnum</span> <span class="o">=</span><span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;fdnum&#39;</span><span class="p">]</span>
        <span class="n">subref</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;subref&#39;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">scan</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">sig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sigch</span> <span class="o">=</span> <span class="n">TF</span><span class="p">[</span><span class="n">sig</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SIG&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">sigch</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;S &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">calch</span> <span class="o">=</span> <span class="n">TF</span><span class="p">[</span><span class="n">cal</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;CAL&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">calch</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ifnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;IFNUM&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ifnum</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PLNUM&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">plnum</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;P &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fdnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;FDNUM&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">fdnum</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;F &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">subref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SUBREF_STATE&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">subref</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SR &#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
        <span class="c1">#TBD: if ifnum is none then we will have to sort these by ifnum, plnum and store separate arrays or something. </span>
        <span class="n">tprows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="c1">#data = self.rawspectra(bintable)[tprows]</span>
        <span class="n">calrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calonoff_rows</span><span class="p">(</span><span class="n">scans</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="n">bintable</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs_opts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TPROWS len=&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tprows</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CALROWS on len=&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">calrows</span><span class="p">[</span><span class="s1">&#39;ON&#39;</span><span class="p">]))</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">GBTTPScan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scan</span><span class="p">,</span><span class="n">sigstate</span><span class="p">[</span><span class="n">sig</span><span class="p">],</span><span class="n">calstate</span><span class="p">[</span><span class="n">cal</span><span class="p">],</span><span class="n">tprows</span><span class="p">,</span><span class="n">calrows</span><span class="p">,</span><span class="n">bintable</span><span class="p">,</span><span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;calibrate&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">g</span></div>


    <span class="c1"># Inspired by Dave Frayer&#39;s snodka: /users/dfrayer/gbtidlpro/snodka</span>
    <span class="c1"># TODO: Figure out when, if done, the fix to the Ka beam labelling took place.</span>
    <span class="c1"># TODO: sig and ref parameters no longer needed? Fix description of calibrate keyword, or possibly eliminate it.</span>
<div class="viewcode-block" id="GBTFITSLoad.subbeamnod">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.subbeamnod">[docs]</a>
    <span class="k">def</span> <span class="nf">subbeamnod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scan</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a subbeam nod power scan, optionally calibrating it.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scan: int</span>
<span class="sd">                scan number</span>
<span class="sd">            method: str</span>
<span class="sd">                Method to use when processing. One of &#39;cycle&#39; or &#39;scan&#39;.  &#39;cycle&#39; is more accurate and averages data in each SUBREF_STATE cycle. &#39;scan&#39; reproduces GBTIDL&#39;s snodka function which has been shown to be less accurate.  Default:&#39;cycle&#39;</span>
<span class="sd">            sig : bool</span>
<span class="sd">                True to indicate if this is the signal scan, False if reference</span>
<span class="sd">            cal: bool</span>
<span class="sd">                True if calibration (diode) is on, False if off.</span>
<span class="sd">            bintable : int</span>
<span class="sd">                the index for BINTABLE in `sdfits` containing the scans</span>
<span class="sd">            calibrate: bool</span>
<span class="sd">                whether or not to calibrate the data.  If `True`, the data will be (calon - caloff)*0.5, otherwise it will be SDFITS row data. Default:True</span>
<span class="sd">            weights: str</span>
<span class="sd">                &#39;equal&#39; or &#39;tsys&#39; to indicate equal weighting or tsys weighting to use in time averaging. Default: &#39;tsys&#39;</span>

<span class="sd">            scan args - ifnum, fdnum, subref  (plnum depends on fdnum)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            data : `~spectra.spectrum.Spectrum`</span>
<span class="sd">                A Spectrum object containing the data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs_opts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;ifnum&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;fdnum&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;timeaverage&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;weights&#39;</span> <span class="p">:</span> <span class="s1">&#39;tsys&#39;</span><span class="p">,</span> <span class="c1"># or None or ndarray</span>
                <span class="s1">&#39;calibrate&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;debug&#39;</span> <span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;cycle&#39;</span><span class="p">,</span>
        <span class="p">}</span> 
        <span class="n">kwargs_opts</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ifnum</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;ifnum&#39;</span><span class="p">]</span>
        <span class="n">fdnum</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;fdnum&#39;</span><span class="p">]</span>
        <span class="n">docal</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;calibrate&#39;</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs_opts</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

        <span class="c1"># Check if we are dealing with Ka data before the beam switch.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">bintable</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">scan</span><span class="p">])]</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;FRONTEND&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;More than one receiver for the selected scan.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Rcvr26_40&quot;</span><span class="p">:</span> <span class="c1"># and df[&quot;DATE-OBS&quot;][-1] &lt; xxxx</span>
            <span class="c1"># Switch the polarizations to match the beams.</span>
            <span class="k">if</span> <span class="n">fdnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plnum</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">fdnum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">plnum</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cycle&#39;</span><span class="p">:</span>
            <span class="c1"># Calibrate each cycle individually and then</span>
            <span class="c1"># average the calibrated data.</span>

            <span class="c1"># Row selection.</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">bintable</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">scan</span><span class="p">])]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;IFNUM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">ifnum</span><span class="p">])]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;FDNUM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">fdnum</span><span class="p">])]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PLNUM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">plnum</span><span class="p">])]</span>
            <span class="n">df_on</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;CAL&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
            <span class="n">df_off</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;CAL&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;F&quot;</span><span class="p">]</span>
            <span class="n">df_on_sig</span> <span class="o">=</span> <span class="n">df_on</span><span class="p">[</span><span class="n">df_on</span><span class="p">[</span><span class="s2">&quot;SUBREF_STATE&quot;</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">df_on_ref</span> <span class="o">=</span> <span class="n">df_on</span><span class="p">[</span><span class="n">df_on</span><span class="p">[</span><span class="s2">&quot;SUBREF_STATE&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">df_off_sig</span> <span class="o">=</span> <span class="n">df_off</span><span class="p">[</span><span class="n">df_off</span><span class="p">[</span><span class="s2">&quot;SUBREF_STATE&quot;</span><span class="p">]</span><span class="o">==-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">df_off_ref</span> <span class="o">=</span> <span class="n">df_off</span><span class="p">[</span><span class="n">df_off</span><span class="p">[</span><span class="s2">&quot;SUBREF_STATE&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sig_on_rows</span>  <span class="o">=</span> <span class="n">df_on_sig</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">ref_on_rows</span>  <span class="o">=</span> <span class="n">df_on_ref</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">sig_off_rows</span> <span class="o">=</span> <span class="n">df_off_sig</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">ref_off_rows</span> <span class="o">=</span> <span class="n">df_off_ref</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="c1"># Define how large of a gap between rows we will tolerate to consider</span>
            <span class="c1"># a row as part of a cycle.</span>
            <span class="c1"># Thinking about it, we should use the SUBREF_STATE=0 as delimiter rather </span>
            <span class="c1"># than this.</span>
            <span class="n">stepsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">udata</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;IFNUM&quot;</span><span class="p">))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">udata</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;PLNUM&quot;</span><span class="p">))</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">ref_on_groups</span> <span class="o">=</span> <span class="n">consecutive</span><span class="p">(</span><span class="n">ref_on_rows</span><span class="p">,</span> <span class="n">stepsize</span><span class="o">=</span><span class="n">stepsize</span><span class="p">)</span>
            <span class="n">sig_on_groups</span> <span class="o">=</span> <span class="n">consecutive</span><span class="p">(</span><span class="n">sig_on_rows</span><span class="p">,</span> <span class="n">stepsize</span><span class="o">=</span><span class="n">stepsize</span><span class="p">)</span>
            <span class="n">ref_off_groups</span> <span class="o">=</span> <span class="n">consecutive</span><span class="p">(</span><span class="n">ref_off_rows</span><span class="p">,</span> <span class="n">stepsize</span><span class="o">=</span><span class="n">stepsize</span><span class="p">)</span>
            <span class="n">sig_off_groups</span> <span class="o">=</span> <span class="n">consecutive</span><span class="p">(</span><span class="n">sig_off_rows</span><span class="p">,</span> <span class="n">stepsize</span><span class="o">=</span><span class="n">stepsize</span><span class="p">)</span>

            <span class="c1"># Make sure we have enough signal and reference pairs.</span>
            <span class="c1"># Same number of cycles or less signal cycles.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_on_groups</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_on_groups</span><span class="p">):</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_on_groups</span><span class="p">))}</span>
            <span class="c1"># One more signal cycle. Re-use one reference cycle.</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_on_groups</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_on_groups</span><span class="p">):</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_on_groups</span><span class="p">))}</span>
                <span class="n">pairs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_on_groups</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_on_groups</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_on_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_on_groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> signal and reference cycles.</span>
<span class="s2">                        Try using method=&#39;scan&#39;.&quot;&quot;&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="c1"># Define the calibrated data array, and </span>
            <span class="c1"># variables to store weights and exposure times.</span>
            <span class="c1"># @TODO: using TDIM7 is fragile if the headers ever change.</span>
            <span class="c1">#  nchan should be gotten from data length</span>
            <span class="c1"># e.g. len(self._hdu[1].data[:][&quot;DATA&quot;][row])</span>
            <span class="c1"># where row is a row number associated with this scan number</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">bintable</span><span class="p">][</span><span class="s2">&quot;TDIM7&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_on_groups</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">ta_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">wt_avg</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># A single value for now, but it should be an array once we implement vector TSYS. </span>
            <span class="n">tsys_wt</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tsys_avg</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">exposure</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Loop over cycles, calibrating each independently.</span>
            <span class="n">groups_zip</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ref_on_groups</span><span class="p">,</span> <span class="n">sig_on_groups</span><span class="p">,</span> <span class="n">ref_off_groups</span><span class="p">,</span> <span class="n">sig_off_groups</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">rgon</span><span class="p">,</span><span class="n">sgon</span><span class="p">,</span><span class="n">rgoff</span><span class="p">,</span><span class="n">sgoff</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups_zip</span><span class="p">):</span>

                <span class="c1"># Do it the dysh way.</span>
                <span class="n">calrows</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ON&quot;</span><span class="p">:</span> <span class="n">rgon</span><span class="p">,</span> <span class="s2">&quot;OFF&quot;</span><span class="p">:</span> <span class="n">rgoff</span><span class="p">}</span>
                <span class="n">tprows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">rgon</span><span class="p">,</span> <span class="n">rgoff</span><span class="p">)))</span>
                <span class="n">reftp</span> <span class="o">=</span> <span class="n">GBTTPScan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="s2">&quot;BOTH&quot;</span><span class="p">,</span> <span class="s2">&quot;BOTH&quot;</span><span class="p">,</span> <span class="n">tprows</span><span class="p">,</span> <span class="n">calrows</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">ref_avg</span> <span class="o">=</span> <span class="n">reftp</span><span class="o">.</span><span class="n">timeaverage</span><span class="p">()</span>
                <span class="n">calrows</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ON&quot;</span><span class="p">:</span> <span class="n">sgon</span><span class="p">,</span> <span class="s2">&quot;OFF&quot;</span><span class="p">:</span> <span class="n">sgoff</span><span class="p">}</span>
                <span class="n">tprows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">sgon</span><span class="p">,</span> <span class="n">sgoff</span><span class="p">)))</span>
                <span class="n">sigtp</span> <span class="o">=</span> <span class="n">GBTTPScan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="s2">&quot;BOTH&quot;</span><span class="p">,</span> <span class="s2">&quot;BOTH&quot;</span><span class="p">,</span> <span class="n">tprows</span><span class="p">,</span> <span class="n">calrows</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">sig_avg</span> <span class="o">=</span> <span class="n">sigtp</span><span class="o">.</span><span class="n">timeaverage</span><span class="p">()</span>
                <span class="c1"># Combine sig and ref.</span>
                <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sig_avg</span><span class="p">)</span>
                <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">new_flux_unit</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">suppress_conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">sig_avg</span> <span class="o">-</span> <span class="n">ref_avg</span><span class="p">)</span><span class="o">/</span><span class="n">ref_avg</span><span class="p">)</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">ref_avg</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;WTTSYS&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span>
                <span class="c1"># TUNIT7 is fragile as locations of specific header data could change in the future.</span>
                <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;TUNIT7&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ta&quot;</span>
                <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;TSYS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_avg</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;WTTSYS&#39;</span><span class="p">]</span>
                
                <span class="c1"># Add to the average, a-la accum.</span>
                <span class="c1"># @TODO possibly replace with a call to util.sq_weighted_avg</span>
                <span class="n">wt_avg</span> <span class="o">+=</span> <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;TSYS&quot;</span><span class="p">]</span><span class="o">**-</span><span class="mf">2.</span>
                <span class="n">ta_avg</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;TSYS&quot;</span><span class="p">]</span><span class="o">**-</span><span class="mf">2.</span>
                <span class="n">tsys_wt_</span> <span class="o">=</span> <span class="n">tsys_weight</span><span class="p">(</span><span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;EXPOSURE&quot;</span><span class="p">],</span> <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;CDELT1&quot;</span><span class="p">],</span> <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;TSYS&quot;</span><span class="p">])</span>
                <span class="n">tsys_wt</span> <span class="o">+=</span> <span class="n">tsys_wt_</span>
                <span class="n">tsys_avg</span> <span class="o">+=</span> <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;TSYS&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">tsys_wt_</span>
                <span class="n">exposure</span> <span class="o">+=</span> <span class="n">ta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;EXPOSURE&quot;</span><span class="p">]</span>

            <span class="c1"># Divide by the sum of the weights.</span>
            <span class="n">ta_avg</span> <span class="o">/=</span> <span class="n">wt_avg</span>
            <span class="n">tsys_avg</span> <span class="o">/=</span> <span class="n">tsys_wt</span>

            <span class="c1"># Set up a Spectrum1D object to return.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">ta_avg</span>
            <span class="n">data</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;TSYS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsys_avg</span>
            <span class="n">data</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;EXPOSURE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exposure</span>
           
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;scan&#39;</span><span class="p">:</span>
            <span class="c1"># Process the whole scan as a single block.</span>
            <span class="c1"># This is less accurate, but might be needed if </span>
            <span class="c1"># the scan was aborted and there are not enough</span>
            <span class="c1"># sig/ref cycles to do a per cycle calibration.</span>

            <span class="n">tpon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettp</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">bintable</span><span class="o">=</span><span class="n">bintable</span><span class="p">,</span><span class="n">fdnum</span><span class="o">=</span><span class="n">fdnum</span><span class="p">,</span>
                               <span class="n">plnum</span><span class="o">=</span><span class="n">plnum</span><span class="p">,</span><span class="n">ifnum</span><span class="o">=</span><span class="n">ifnum</span><span class="p">,</span>
                               <span class="n">subref</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">calibrate</span><span class="o">=</span><span class="n">docal</span><span class="p">)</span>
            <span class="n">tpoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettp</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">bintable</span><span class="o">=</span><span class="n">bintable</span><span class="p">,</span><span class="n">fdnum</span><span class="o">=</span><span class="n">fdnum</span><span class="p">,</span>
                               <span class="n">plnum</span><span class="o">=</span><span class="n">plnum</span><span class="p">,</span><span class="n">ifnum</span><span class="o">=</span><span class="n">ifnum</span><span class="p">,</span><span class="n">subref</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">weight</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">calibrate</span><span class="o">=</span><span class="n">docal</span><span class="p">)</span>
            
            <span class="n">on</span>  <span class="o">=</span>  <span class="n">tpon</span><span class="o">.</span><span class="n">timeaverage</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
            <span class="n">off</span> <span class="o">=</span> <span class="n">tpoff</span><span class="o">.</span><span class="n">timeaverage</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
            
            <span class="c1"># in order to reproduce gbtidl tsys, we need to do a normal</span>
            <span class="c1"># total power scan</span>
            <span class="n">fulltp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettp</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span><span class="n">sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">bintable</span><span class="o">=</span><span class="n">bintable</span><span class="p">,</span><span class="n">fdnum</span><span class="o">=</span><span class="n">fdnum</span><span class="p">,</span>
                            <span class="n">plnum</span><span class="o">=</span><span class="n">plnum</span><span class="p">,</span><span class="n">ifnum</span><span class="o">=</span><span class="n">ifnum</span><span class="p">,</span>
                            <span class="n">weight</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">calibrate</span><span class="o">=</span><span class="n">docal</span><span class="p">)</span><span class="o">.</span><span class="n">timeaverage</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
            <span class="n">tsys</span> <span class="o">=</span> <span class="n">fulltp</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TSYS&#39;</span><span class="p">]</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">tsys</span><span class="o">*</span><span class="p">(</span><span class="n">on</span> <span class="o">-</span> <span class="n">off</span><span class="p">)</span><span class="o">/</span><span class="n">off</span>
            <span class="n">data</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;MEANTSYS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">on</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TSYS&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">off</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TSYS&#39;</span><span class="p">]))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;WTTSYS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsys</span>
            <span class="n">data</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TSYS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;WTTSYS&#39;</span><span class="p">]</span>
            <span class="c1">#if kwargs_opts[&#39;debug&#39;]:</span>
            <span class="c1">#    data._on = tpon</span>
            <span class="c1">#    data._off = tpoff</span>
            <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="GBTFITSLoad.onoff_scan_list">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.onoff_scan_list">[docs]</a>
    <span class="k">def</span> <span class="nf">onoff_scan_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ifnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">plnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the scan row indices for position-switch data sorted </span>
<span class="sd">           by ON and OFF state</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scans : int or list-like</span>
<span class="sd">                The scan numbers to find the rows of</span>
<span class="sd">            ifnum : int</span>
<span class="sd">                the IF index</span>
<span class="sd">            plnum : int</span>
<span class="sd">                the polarization index</span>
<span class="sd">            bintable : int</span>
<span class="sd">                the index for BINTABLE containing the scans</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            rows : dict</span>
<span class="sd">                A dictionary with keys &#39;ON&#39; and &#39;OFF&#39; giving the row indices of ON and OFF data for the input scan(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_index_if_needed</span><span class="p">()</span>
        <span class="c1">#print(f&quot;onoff_scan_list(scans={scans},if={ifnum},pl={plnum})&quot;)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ON&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;OFF&quot;</span> <span class="p">:[]}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scans</span><span class="p">]</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># this does all bintables.</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">:</span>
                <span class="c1">#OnOff lowest scan number is on</span>
                <span class="c1">#dfonoff = self.select(df,&quot;PROC&quot;,&quot;OnOff&quot;))</span>
                <span class="c1">#OffOn lowest scan number is off</span>
                <span class="c1">#dfoffon = self.select(df,&quot;PROC&quot;,&quot;OffOn&quot;))</span>
                <span class="n">dfon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;_OBSTYPE&quot;</span><span class="p">,</span><span class="s2">&quot;PSWITCHON&quot;</span><span class="p">,</span><span class="n">df</span><span class="p">)</span>
                <span class="n">dfoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;_OBSTYPE&quot;</span><span class="p">,</span><span class="s2">&quot;PSWITCHOFF&quot;</span><span class="p">,</span><span class="n">df</span><span class="p">)</span>
                <span class="n">onscans</span> <span class="o">=</span> <span class="n">uniq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dfon</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]))</span>
                <span class="c1">#print(&quot;ON: &quot;,onscans)</span>
                <span class="n">s</span><span class="p">[</span><span class="s2">&quot;ON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">onscans</span><span class="p">)</span>
                <span class="n">offscans</span> <span class="o">=</span> <span class="n">uniq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dfoff</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]))</span>
                <span class="c1">#print(&quot;OFF: &quot;,offscans)</span>
                <span class="n">s</span><span class="p">[</span><span class="s2">&quot;OFF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">offscans</span><span class="p">)</span>

        <span class="n">df</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">bintable</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PLNUM&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">plnum</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;IFNUM&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ifnum</span><span class="p">)]</span>
        <span class="n">dfon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;_OBSTYPE&quot;</span><span class="p">,</span><span class="s2">&quot;PSWITCHON&quot;</span><span class="p">,</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dfoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;_OBSTYPE&quot;</span><span class="p">,</span><span class="s2">&quot;PSWITCHOFF&quot;</span><span class="p">,</span><span class="n">df</span><span class="p">)</span>
        <span class="n">onscans</span> <span class="o">=</span> <span class="n">uniq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dfon</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]))</span> <span class="c1"># wouldn&#39;t set() do this too?</span>
        <span class="n">offscans</span> <span class="o">=</span> <span class="n">uniq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dfoff</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">scans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># The companion scan will always be +/- 1 depending if procseqn is 1(ON) or 2(OFF)</span>
        <span class="c1"># First check the requested scan number(s) are even in the ONs or OFFs of this bintable</span>
            <span class="n">seton</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">onscans</span><span class="p">)</span>
            <span class="n">setoff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">offscans</span><span class="p">)</span>
            <span class="n">onrequested</span> <span class="o">=</span> <span class="n">seton</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span>
            <span class="c1">#print(&quot;ON REQUESTED &quot;,onrequested)</span>
            <span class="n">offrequested</span> <span class="o">=</span> <span class="n">setoff</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span>
            <span class="c1">#print(&quot;OFF REQUESTED &quot;,offrequested)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">onrequested</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">offrequested</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scans </span><span class="si">{</span><span class="n">scans</span><span class="si">}</span><span class="s2"> not found in ONs or OFFs of bintable </span><span class="si">{</span><span class="n">bintable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Then check that for each requested ON/OFF there is a matching OFF/ON</span>
        <span class="c1"># and build the final matched list of ONs and OFfs.</span>
            <span class="n">sons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">onrequested</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">soffs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">offrequested</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">missingoff</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">missingon</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">onrequested</span><span class="p">:</span>
                <span class="n">expectedoff</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="c1">#print(f&quot;DOING ONQUESTED {i}, looking for off {expectedoff}&quot;)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">setoff</span><span class="o">.</span><span class="n">intersection</span><span class="p">([</span><span class="n">expectedoff</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">missingoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expectedoff</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">soffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expectedoff</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">offrequested</span><span class="p">:</span>
                <span class="n">expectedon</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
                <span class="c1">#print(f&quot;DOING OFFEQUESTED {i}, looking for on {expectedon}&quot;)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seton</span><span class="o">.</span><span class="n">intersection</span><span class="p">([</span><span class="n">expectedon</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">missingon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expectedon</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expectedon</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missingoff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For the requested ON scans </span><span class="si">{</span><span class="n">onrequested</span><span class="si">}</span><span class="s2">, the OFF scans </span><span class="si">{</span><span class="n">missingoff</span><span class="si">}</span><span class="s2"> were not present in bintable </span><span class="si">{</span><span class="n">bintable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missingon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For the requested OFF scans </span><span class="si">{</span><span class="n">offrequested</span><span class="si">}</span><span class="s2">, the ON scans </span><span class="si">{</span><span class="n">missingon</span><span class="si">}</span><span class="s2"> were not present in bintable </span><span class="si">{</span><span class="n">bintable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">#print(&quot;ON&quot;,sorted(sons))</span>
            <span class="c1">#print(&quot;OFF&quot;,sorted(soffs))</span>
            <span class="n">s</span><span class="p">[</span><span class="s2">&quot;ON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sons</span><span class="p">))</span>
            <span class="n">s</span><span class="p">[</span><span class="s2">&quot;OFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">soffs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="p">[</span><span class="s2">&quot;ON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uniq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dfon</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]))</span>
            <span class="n">s</span><span class="p">[</span><span class="s2">&quot;OFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uniq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dfoff</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="GBTFITSLoad.calonoff_rows">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.calonoff_rows">[docs]</a>
    <span class="k">def</span> <span class="nf">calonoff_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get individual scan row numbers  sorted by whether the calibration (diode) was on or off, and selected by ifnum,plnum, fdnum,subref,bintable.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scans : int or list-like</span>
<span class="sd">                The scan numbers to find the rows of</span>
<span class="sd">            ifnum : int</span>
<span class="sd">                the IF index</span>
<span class="sd">            plnum : int</span>
<span class="sd">                the polarization index</span>
<span class="sd">            fdnum : int</span>
<span class="sd">                the feed index</span>
<span class="sd">            subref : int</span>
<span class="sd">                the subreflector state (-1,0,1)</span>
<span class="sd">            bintable : int</span>
<span class="sd">                the index for BINTABLE containing the scans</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            rows : dict</span>
<span class="sd">                A dictionary with keys &#39;ON&#39; and &#39;OFF&#39; giving the row indices of CALON and CALOFF data for the input scan(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_index_if_needed</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ON&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;OFF&quot;</span> <span class="p">:[]}</span>
        <span class="n">ifnum</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ifnum&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">plnum</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;plnum&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">fdnum</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fdnum&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">subref</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subref&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scans</span><span class="p">]</span>
        <span class="n">df</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">bintable</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scans</span><span class="p">)]</span>
        <span class="n">dfon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;CAL&quot;</span><span class="p">,</span><span class="s2">&quot;T&quot;</span><span class="p">,</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dfoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;CAL&quot;</span><span class="p">,</span><span class="s2">&quot;F&quot;</span><span class="p">,</span><span class="n">df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ifnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dfon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;IFNUM&quot;</span><span class="p">,</span><span class="n">ifnum</span><span class="p">,</span><span class="n">dfon</span><span class="p">)</span>
            <span class="n">dfoff</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;IFNUM&quot;</span><span class="p">,</span><span class="n">ifnum</span><span class="p">,</span><span class="n">dfoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dfon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;PLNUM&quot;</span><span class="p">,</span><span class="n">plnum</span><span class="p">,</span><span class="n">dfon</span><span class="p">)</span>
            <span class="n">dfoff</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;PLNUM&quot;</span><span class="p">,</span><span class="n">plnum</span><span class="p">,</span><span class="n">dfoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fdnum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dfon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;FDNUM&quot;</span><span class="p">,</span><span class="n">fdnum</span><span class="p">,</span><span class="n">dfon</span><span class="p">)</span>
            <span class="n">dfoff</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;FDNUM&quot;</span><span class="p">,</span><span class="n">fdnum</span><span class="p">,</span><span class="n">dfoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dfon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;SUBREF_STATE&quot;</span><span class="p">,</span><span class="n">subref</span><span class="p">,</span><span class="n">dfon</span><span class="p">)</span>
            <span class="n">dfoff</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;SUBREF_STATE&quot;</span><span class="p">,</span><span class="n">subref</span><span class="p">,</span><span class="n">dfoff</span><span class="p">)</span>
        <span class="n">s</span><span class="p">[</span><span class="s2">&quot;ON&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfon</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">s</span><span class="p">[</span><span class="s2">&quot;OFF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfoff</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="GBTFITSLoad.onoff_rows">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.onoff_rows">[docs]</a>
    <span class="k">def</span> <span class="nf">onoff_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ifnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">plnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get individual ON/OFF (position switch) scan row numbers selected by ifnum,plnum, bintable.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scans : int or list-like</span>
<span class="sd">                The scan numbers to find the rows of</span>
<span class="sd">            ifnum : int</span>
<span class="sd">                the IF index</span>
<span class="sd">            plnum : int</span>
<span class="sd">                the polarization index</span>
<span class="sd">            bintable : int</span>
<span class="sd">                the index for BINTABLE in `sdfits` containing the scans</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            rows : dict</span>
<span class="sd">                A dictionary with keys &#39;ON&#39; and &#39;OFF&#39; giving the row indices of the ON and OFF data for the input scan(s)</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="c1">#@TODO deal with mulitple bintables</span>
    <span class="c1">#@TODO rename this sigref_rows?</span>
    <span class="c1"># keep the bintable keyword and allow iteration over bintables if requested (bintable=None) </span>
        <span class="c1">#print(f&quot;onoff_rows(scans={scans},if={ifnum},pl={plnum})&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_index_if_needed</span><span class="p">()</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ON&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;OFF&quot;</span> <span class="p">:[]}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scans</span><span class="p">]</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">onoff_scan_list</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span><span class="n">ifnum</span><span class="p">,</span><span class="n">plnum</span><span class="p">,</span><span class="n">bintable</span><span class="p">)</span>
        <span class="c1">#scans is now a dict of &quot;ON&quot; &quot;OFF</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span> 
            <span class="n">rows</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_rows</span><span class="p">(</span><span class="n">scans</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="n">ifnum</span><span class="p">,</span><span class="n">plnum</span><span class="p">,</span><span class="n">bintable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rows</span></div>

        
<div class="viewcode-block" id="GBTFITSLoad.scan_rows">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.scan_rows">[docs]</a>
    <span class="k">def</span> <span class="nf">scan_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scans</span><span class="p">,</span><span class="n">ifnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">plnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">bintable</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get scan rows selected by ifnum,plnum, bintable.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scans : int or list-like</span>
<span class="sd">                The scan numbers to find the rows of</span>
<span class="sd">            ifnum : int</span>
<span class="sd">                the IF index</span>
<span class="sd">            plnum : int</span>
<span class="sd">                the polarization index</span>
<span class="sd">            bintable : int</span>
<span class="sd">                the index for BINTABLE in `sdfits` containing the scans</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            rows : list</span>
<span class="sd">                Lists of the rows in each bintable that contain the scans. Index of `rows` is the bintable index number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#scans is a list</span>
        <span class="c1">#print(f&quot;scan_rows(scans={scans},if={ifnum},pl={plnum})&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_index_if_needed</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">scans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;scans&#39; cannot be None. It must be int or list of int&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">[</span><span class="n">bintable</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;IFNUM&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ifnum</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;PLNUM&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">plnum</span><span class="p">)]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scans </span><span class="si">{</span><span class="n">scans</span><span class="si">}</span><span class="s2"> not found in bintable </span><span class="si">{</span><span class="n">bintable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rows</span></div>


    <span class="k">def</span> <span class="nf">_scan_rows_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scans</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get scan rows regardless of ifnum,plnum, bintable.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            scans : int or list-like</span>
<span class="sd">                The scan numbers to find the rows of</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            rows : list</span>
<span class="sd">                Lists of the rows in each bintable that contain the scans. Index of `rows` is the bintable index number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;scans&#39; cannot be None. It must be int or list of int&quot;</span><span class="p">)</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ptable</span><span class="p">:</span>
            <span class="n">df_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;SCAN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scans</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_out</span><span class="p">:</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rows</span>

<div class="viewcode-block" id="GBTFITSLoad.write_scans">
<a class="viewcode-back" href="../../../modules/dysh.fits.html#dysh.fits.gbtfitsload.GBTFITSLoad.write_scans">[docs]</a>
    <span class="k">def</span> <span class="nf">write_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileobj</span><span class="p">,</span><span class="n">scans</span><span class="p">,</span><span class="n">output_verify</span><span class="o">=</span><span class="s2">&quot;exception&quot;</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">checksum</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write specific scans of the `GBTFITSLoad` to a new file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileobj : str, file-like or `pathlib.Path`</span>
<span class="sd">            File to write to.  If a file object, must be opened in a</span>
<span class="sd">            writeable mode.</span>

<span class="sd">        scans: int or list-like</span>
<span class="sd">            Range of scans to write out. e.g. 0, [14,25,32]. </span>

<span class="sd">        output_verify : str</span>
<span class="sd">            Output verification option.  Must be one of ``&quot;fix&quot;``,</span>
<span class="sd">            ``&quot;silentfix&quot;``, ``&quot;ignore&quot;``, ``&quot;warn&quot;``, or</span>
<span class="sd">            ``&quot;exception&quot;``.  May also be any combination of ``&quot;fix&quot;`` or</span>
<span class="sd">            ``&quot;silentfix&quot;`` with ``&quot;+ignore&quot;``, ``+warn``, or ``+exception&quot;</span>
<span class="sd">            (e.g. ``&quot;fix+warn&quot;``).  See https://docs.astropy.org/en/latest/io/fits/api/verification.html for more info</span>

<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If ``True``, overwrite the output file if it exists. Raises an</span>
<span class="sd">            ``OSError`` if ``False`` and the output file exists. Default is</span>
<span class="sd">            ``False``.</span>

<span class="sd">        checksum : bool</span>
<span class="sd">            When `True` adds both ``DATASUM`` and ``CHECKSUM`` cards</span>
<span class="sd">            to the headers of all HDU&#39;s written to the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the rows that contain the scans in all bintables</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan_rows_all</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span>
        <span class="c1">#print(&quot;Using rows&quot;,rows)</span>
        <span class="n">hdu0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">hdu0</span><span class="p">)</span>
        <span class="c1"># get the bintables rows as new bintables.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)):</span>
            <span class="n">ob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bintable_from_rows</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">)</span>
            <span class="c1">#print(f&quot;bintable {i} #rows {len(rows[i])} data length {len(ob.data)}&quot;)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ob</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">outhdu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ob</span><span class="p">)</span>
        <span class="c1">#print(outhdu.info())</span>
        <span class="c1"># write it out!</span>
        <span class="n">outhdu</span><span class="o">.</span><span class="n">update_extend</span><span class="p">()</span> <span class="c1"># possibly unneeded</span>
        <span class="n">outhdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span>
            <span class="n">output_verify</span><span class="o">=</span><span class="n">output_verify</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="n">checksum</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Green Bank Observatory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>